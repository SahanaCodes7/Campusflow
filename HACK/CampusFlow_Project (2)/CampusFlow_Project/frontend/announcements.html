<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Announcements - CampusFlow</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-gradient-to-b from-indigo-50 to-indigo-100 h-screen shadow-lg p-5 border-r border-indigo-200">
            <h2 class="text-2xl font-extrabold mb-8 text-indigo-700 tracking-wide">ðŸŽ“ CampusFlow</h2>
            <nav class="space-y-3">
                <a href="index.html" class="flex items-center gap-2 p-2 rounded-md text-indigo-700 hover:bg-indigo-100 hover:text-indigo-800">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" />
                        <path d="M3 9h18" />
                    </svg>
                    Dashboard
                </a>
                <a href="assignments.html" class="flex items-center gap-2 p-2 rounded-md text-indigo-700 hover:bg-indigo-100 hover:text-indigo-800">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2" />
                        <rect x="9" y="3" width="6" height="4" rx="1" />
                        <path d="M9 14h6" />
                        <path d="M9 10h6" />
                        <path d="M9 18h6" />
                    </svg>
                    Assignments
                </a>
                <a href="alerts.html" class="flex items-center gap-2 p-2 rounded-md text-indigo-700 hover:bg-indigo-100 hover:text-indigo-800">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                        <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                    </svg>
                    Alerts
                </a>
                <a href="announcements.html" class="flex items-center gap-2 p-2 rounded-md bg-indigo-200 text-indigo-900 font-semibold">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 3v10M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9-4.03-9-9-9z" />
                        <path d="M12 17h.01" />
                    </svg>
                    Announcements
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">ðŸ“¢ Announcements</h1>
                    <button id="new-announcement-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                        + New Announcement
                    </button>
                </div>
                
                <!-- New Announcement Form (hidden by default) -->
                <div id="announcement-form" class="hidden bg-white p-6 rounded-lg shadow-md mb-6">
                    <h2 class="text-xl font-semibold mb-4">Create New Announcement</h2>
                    <form id="create-announcement-form">
                        <div class="mb-4">
                            <label for="title" class="block text-gray-700 font-medium mb-2">Title</label>
                            <input type="text" id="title" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="mb-4">
                            <label for="message" class="block text-gray-700 font-medium mb-2">Message</label>
                            <textarea id="message" name="message" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required></textarea>
                        </div>
                        <div class="flex justify-end gap-3">
                            <button type="button" id="cancel-announcement" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Post Announcement</button>
                        </div>
                    </form>
                </div>
                
                <!-- Announcements List -->
                <div id="announcements-container" class="space-y-4">
                    <!-- Announcements will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Load socket.io client from CDN so the page works when opened directly -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="script.js"></script>
        <script>
            // Prefer the socket created by script.js. If it's not present, try creating one
            // via the io() factory. Use `pageSocket` locally so we don't redeclare the
            // global `socket` constant from script.js (which would throw).
            const pageSocket = (typeof socket !== 'undefined') ? socket : ((typeof io === 'function') ? io() : null);

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize announcements list
            if (typeof loadAnnouncements === 'function') loadAnnouncements();
        });

        // Listen for real-time announcements and refresh
            if (pageSocket) {
                pageSocket.on('announcement', (announcement) => {
                console.log('ðŸ“¢ New announcement received:', announcement);
                if (typeof loadAnnouncements === 'function') loadAnnouncements();
                if (typeof showNotification === 'function') showNotification(announcement.title);
            });
        }

    // Get DOM elements
    const announcementsContainer = document.getElementById('announcements-container');
    const newAnnouncementBtn = document.getElementById('new-announcement-btn');    
    const announcementForm = document.getElementById('announcement-form');
    const createAnnouncementForm = document.getElementById('create-announcement-form');
    const cancelAnnouncementBtn = document.getElementById('cancel-announcement');

        // Event Listeners
        newAnnouncementBtn.addEventListener('click', () => {
            announcementForm.classList.remove('hidden');
            newAnnouncementBtn.classList.add('hidden');
        });

        cancelAnnouncementBtn.addEventListener('click', () => {
            announcementForm.classList.add('hidden');
            newAnnouncementBtn.classList.remove('hidden');
            createAnnouncementForm.reset();
        });

        createAnnouncementForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('title').value,
                message: document.getElementById('message').value
            };

            try {
                // disable button to prevent duplicate submits
                if (newAnnouncementBtn) newAnnouncementBtn.disabled = true;
                // Use BACKEND_BASE from script.js so the request goes to the correct origin
                const url = (typeof BACKEND_BASE !== 'undefined') ? `${BACKEND_BASE}/api/announcements` : `${window.location.origin}/api/announcements`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    // Try to extract server error message for debugging
                    let errText = `HTTP ${response.status}`;
                    try { const body = await response.json(); if (body && body.error) errText += ` - ${body.error}`; } catch(e) { /* ignore */ }
                    throw new Error('Failed to post announcement: ' + errText);
                }
                // Try to parse server response
                let result = null;
                try { result = await response.json(); } catch (e) { /* ignore */ }

                // Hide form and show button
                announcementForm.classList.add('hidden');
                newAnnouncementBtn.classList.remove('hidden');
                createAnnouncementForm.reset();

                // Immediately refresh list (fallback) and show success message
                if (typeof loadAnnouncements === 'function') {
                    loadAnnouncements();
                } else if (result && result.announcement) {
                    // Fallback: append the returned announcement
                    addAnnouncementToList(result.announcement);
                }

                showNotification('Announcement posted successfully!', 'success');
                } catch (error) {
                    console.error('Error posting announcement:', error);
                    // Show more helpful message to the user
                    showNotification('Failed to post announcement. See console for details.', 'error');
                } finally {
                    // Re-enable UI if disabled
                    if (newAnnouncementBtn) newAnnouncementBtn.disabled = false;
                }
        });

        // The page relies on script.js which already calls `loadAnnouncements()` on DOMContentLoaded
        // and listens for socket 'announcement' events to refresh the list. This avoids duplicate
        // fetching and ensures a single source of truth for rendering announcements.

        function addAnnouncementToList(announcement) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow-md p-6 border-l-4 border-indigo-500 transform transition-all duration-300 hover:scale-[1.02]';
            
            const timestamp = new Date(announcement.timestamp).toLocaleString();
            
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">${escapeHtml(announcement.title)}</h3>
                    <span class="text-sm text-gray-400">
                        ${timestamp}
                    </span>
                </div>
                <p class="text-gray-600 mb-3 whitespace-pre-wrap">${escapeHtml(announcement.message)}</p>
            `;
            
            // Insert at top of announcements container
            if (announcementsContainer) announcementsContainer.insertBefore(div, announcementsContainer.firstChild);
        }

        function showEmptyState() {
            if (announcementsContainer) announcementsContainer.innerHTML = `
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">ðŸ“¢</div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">No Announcements Yet</h3>
                    <p class="text-gray-500">Be the first to post an announcement!</p>
                </div>
            `;
        }

        function removeEmptyState() {
            if (announcementsContainer && announcementsContainer.querySelector('.text-center')) {
                announcementsContainer.innerHTML = '';
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } transform transition-all duration-300 opacity-0`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Fade in
            setTimeout(() => notification.classList.add('opacity-100'), 10);
            
            // Fade out and remove
            setTimeout(() => {
                notification.classList.remove('opacity-100');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>