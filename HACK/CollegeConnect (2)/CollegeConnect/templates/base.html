<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!doctype html>
  <html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>{{ title or "CollegeConnect" }}</title>

    <!-- Bootstrap + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg" style="background:linear-gradient(90deg,#0ea5e9,#0369a1);">
      <div class="container">
        <a class="navbar-brand text-white fw-bold" href="{{ url_for('index') }}">
          <i class="bi bi-building"></i> CollegeConnect
        </a>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-4">
      {% block content %}{% endblock %}
    </div>

    <!-- Footer -->
    <footer class="text-center py-3" style="background:linear-gradient(90deg,#0369a1,#0ea5e9); color:white;">
      ¬© 2025 CollegeConnect
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ========== SOCKET.IO + ALERT SYSTEM ========== -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- Visible alert container -->
    <div class="active-alerts" style="margin:12px; padding:12px; background:#fff; border-radius:8px;">
      <h4>Active Alerts</h4>
    </div>

    <script>
      // === CONFIG: your Node backend URL ===
      const BACKEND_BASE = 'http://localhost:3000';

      // helper: escape HTML to avoid injection in dynamic content
      function escapeHtml(str) {
        if (!str) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      // Connect to Socket.IO backend
        const socket = io(BACKEND_BASE);

      socket.on('connect', () => console.log('‚úÖ Connected to backend socket:', socket.id));
      socket.on('disconnect', () => console.warn('‚ö†Ô∏è Disconnected from backend socket'));

      // When backend sends alert, show it in Active Alerts and prepend a deduped update card
      socket.on('alert', (alert) => {
        try {
          console.log('üì¢ New Alert:', alert);
          const list = document.querySelector('.active-alerts');
          const el = document.createElement('div');
          el.style.padding = '8px';
          el.style.margin = '6px 0';
          el.style.borderRadius = '6px';
          el.style.background = '#f8f9fa';
          el.innerHTML = `\n          <b>üîî ${escapeHtml(alert.message || alert.title || 'Alert received')}</b>\n          <div style="font-size:12px;color:#666;">${new Date(alert.timestamp || Date.now()).toLocaleString()}</div>`;
          list.prepend(el);

          // Insert a deduped visual card into the updates column (if exists)
          try {
            const updatesContainer = document.getElementById('updatesColumn');
            if (updatesContainer) {
              const key = (alert.title || alert.message || '') + '|' + (alert.timestamp || '');
              const safeKey = escapeHtml(key);
              if (!updatesContainer.querySelector(`[data-alert-key="${safeKey}"]`)) {
                const card = document.createElement('div');
                card.className = 'card mb-3 update-card';
                card.setAttribute('data-alert-key', safeKey);
                const body = document.createElement('div');
                body.className = 'card-body';
                const titleText = alert.title || alert.message || 'Alert';
                const contentText = alert.message || '';
                const dtText = alert.timestamp || new Date().toISOString();
                body.innerHTML = `\n                <div class="d-flex justify-content-between">\n                  <div>\n                    <h5 class="mb-1">${escapeHtml(titleText)} <span class="badge bg-info text-dark ms-2">${escapeHtml(alert.type || 'Alert')}</span></h5>\n                    <p class="mb-1 text-muted">${escapeHtml(contentText)}</p>\n                    <small class="text-muted"><i class="bi bi-clock"></i> ${new Date(dtText).toLocaleString()}</small>\n                  </div>\n                </div>`;
                card.appendChild(body);
                const heading = updatesContainer.querySelector('h4');
                if (heading) heading.insertAdjacentElement('afterend', card);
                else updatesContainer.prepend(card);
              }
            }
          } catch (e) {
            console.error('Error inserting alert card:', e);
          }
        } catch (e) {
          console.error('Error handling incoming alert:', e);
        }
      });

      // Event listeners for notifications
      socket.on('announcement', () => {
        // Future: Handle any announcement updates if needed
      });
      socket.on('alert', () => {
        // Future: Handle any alert updates if needed
      });
      socket.on('sync-complete', () => {
        // Future: Handle any sync completion actions if needed
      });

      // Small helper to send an alert to CampusFlow backend (so it persists and broadcasts)
      async function sendAlertHTTP(payload) {
        try {
          const res = await fetch(BACKEND_BASE + '/alerts', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
          });
          return res.json();
        } catch (e) {
          console.error('Failed to send alert to backend:', e);
        }
      }

      // onUserAction: small utility used by the test button. It will send an alert to CampusFlow.
      async function onUserAction(actionType, opts) {
        const payload = {
          title: opts?.message || actionType,
          message: opts?.message || '',
          timestamp: new Date().toISOString()
        };
        await sendAlertHTTP(payload);
        console.log('onUserAction sent', payload);
      }

      // Expose for debugging in console
      window.onUserAction = onUserAction;
      window.socket = socket;

      console.log('‚öôÔ∏è Alert system initialized for CollegeConnect');
    </script>

    <!-- Quick Test Button -->
    <button id="cf-test-alert" style="position:fixed; right:12px; bottom:12px; z-index:9999; padding:10px 14px; border:none; border-radius:6px; background:#0369a1; color:#fff;">üîî Send Test Alert</button>

    <script>
      document.getElementById('cf-test-alert').addEventListener('click', () => {
        onUserAction('manual_test', { message: 'Manual test alert from UI' });
        console.log('Manual test alert sent');
      });
    </script>
    <!-- ========== END ALERT SYSTEM ========== -->

  </body>
  </html>
                    }
